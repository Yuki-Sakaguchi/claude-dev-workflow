# TDD・テスト戦略（Claude Code自動実行用）

## 基本方針

**個人開発に最適化した3層テスト戦略**

1. **単体テスト（TDD）**: 全機能で必須実行
2. **統合テスト**: API・DB連携部分のみ
3. **E2Eテスト**: 主要なユーザーシナリオのみ

## TDDサイクル（自動実行）

### Red → Green → Refactor + 上位テスト

**Claude Codeの実行順序：**

1. **Red**: 失敗する単体テストを作成
2. **Green**: 最小限の実装でテスト通過
3. **Refactor**: コード品質向上（テスト結果は変更しない）
4. **Integration**: 必要に応じて統合テスト追加
5. **E2E**: 主要機能の場合はE2Eテスト追加

### 各段階のコミット例

```bash
# Red: 失敗テスト作成
git commit -m "test: add user login validation test (failing)"

# Green: 最小実装
git commit -m "feat: implement basic user login"

# Refactor: リファクタリング
git commit -m "refactor: extract validation logic"

# Integration: 統合テスト
git commit -m "test: add login API integration test"

# E2E: E2Eテスト
git commit -m "test: add user login flow e2e test"
```

## テスト種別と実行基準

### 単体テスト（必須）

**対象**: 全ての関数・メソッド・コンポーネント

**実行タイミング**: TDDサイクルの都度

**カバレッジ目標**: 80%以上

**例**:
- ユーザー入力バリデーション
- ビジネスロジック
- ユーティリティ関数
- Reactコンポーネントの描画・操作（Testing Library）

### コンポーネントテスト（UI関連）

**対象**: UIコンポーネント

**ツール**: Storybook

**実行タイミング**: コンポーネント作成・更新時

**例**:
- ボタン、フォーム、モーダルの表示確認
- 様々なpropsでの描画確認
- インタラクション（クリック、入力）の動作確認

### 統合テスト（条件付き）

**対象**: 以下の場合のみ実装

- データベース操作を含む機能
- 外部API連携機能
- 複数コンポーネント間の連携
- フロントエンド・バックエンド間の連携

**実行タイミング**: 単体テスト完了後

**例**:
- API エンドポイントのテスト（Supertest）
- データベースCRUD操作
- 認証・認可フロー
- ページ全体のコンポーネント連携（Testing Library）

### E2Eテスト（重要機能のみ）

**対象**: 以下の重要シナリオのみ

- ユーザー登録・ログイン
- 主要な業務フロー
- 決済・課金処理

**ツール**: Playwright

**実行タイミング**: 機能完成後

**例**:
- 「新規ユーザーが登録からログインまで完了する」
- 「商品購入から決済完了まで」
- 「フォーム入力から確認画面、送信完了まで」

## Claude Code自動判断ルール

### 機能の重要度によるテスト範囲自動決定

**Critical（重要）**: 単体 + コンポーネント + 統合 + E2E
- 認証・認可
- 決済処理
- データ保存・更新

**Important（一般）**: 単体 + コンポーネント + 統合
- API エンドポイント
- DB操作を含む機能
- 主要なUIコンポーネント

**Normal（軽微）**: 単体 + コンポーネント
- ユーティリティ関数
- 単純なUIコンポーネント
- バリデーション

### 自動判断の例

**issue内容**: "ユーザーログイン機能"

**Claude Code判断**: Critical → 全テスト実装

**実行内容**:
1. ログイン関数の単体テスト（Vitest + TDD）
2. ログインコンポーネントのテスト（Testing Library）
3. ログインフォームのStorybook作成
4. ログインAPIの統合テスト
5. ログイン画面からダッシュボード遷移のE2E（Playwright）

## テスト失敗時の対応（自動実行）

### 単体テスト失敗
1. エラー内容を分析
2. 最小限の修正で通過させる
3. 通過後にリファクタリング

### 統合テスト失敗
1. 依存関係（DB、API）の状態確認
2. モックの見直し
3. 必要に応じて環境設定調整

### E2Eテスト失敗
1. ブラウザ環境・画面サイズの確認
2. 待機時間の調整
3. セレクタの見直し

## テスト環境・ツール

### 使用ツール（フロントエンド・バックエンド対応）
- **単体テスト**: Vitest + Testing Library
- **コンポーネントテスト**: Storybook（UIコンポーネント）
- **統合テスト**: Vitest + Testing Library（フロントエンド）/ Supertest（API）
- **E2Eテスト**: Playwright

### CI/CD自動実行
```yaml
# PR作成時の自動テスト実行順序
1. 単体テスト（Vitest）必須
2. コンポーネントテスト（Storybook build）必須
3. 統合テスト（該当機能のみ）
4. E2Eテスト（Playwright - Critical機能のみ）

# 全テスト通過でのみマージ許可
```

## Claude Codeへの期待動作

### 理想的な実行例

**ユーザー**: "issue #15 の決済処理機能を実装して"

**Claude Code自動判断**: "Critical機能のため全テスト実装"

**自動実行内容**:
1. 決済処理の単体テスト作成（Vitest + TDD）
2. 決済フォームコンポーネント作成（Testing Library + Storybook）
3. 決済API統合テスト作成
4. 決済フローE2Eテスト作成（Playwright）
5. 全テスト通過確認
6. PR作成

## 品質チェックポイント

### PR作成前の自動確認項目
- [ ] 全単体テスト通過（Vitest）
- [ ] カバレッジ80%以上
- [ ] Storybookビルド成功
- [ ] 統合テスト通過（該当する場合）
- [ ] E2Eテスト通過（Playwright - Critical機能の場合）
- [ ] リンター・フォーマッターチェック

### 継続的品質改善
- 週次でテストカバレッジレポート確認
- 失敗頻度の高いテストの見直し
- E2Eテストの実行時間最適化